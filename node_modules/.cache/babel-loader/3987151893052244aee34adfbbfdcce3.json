{"ast":null,"code":"var os = require('os');\n\nvar util = require('util');\n\nvar _ = require('lodash');\n\nvar S = require('string');\n\nvar moment = require('moment');\n\nvar Promise = require('bluebird');\n\nvar _constants = require('./constants');\n\nvar _utils = require('./utils');\n\nvar getCrumb = require('./yahooCrumb').getCrumb;\n\nfunction _sanitizeHistoricalOptions(options) {\n  if (!_.isPlainObject(options)) {\n    throw new Error('\"options\" must be a plain object.');\n  }\n\n  if (_.isUndefined(options.symbol) && _.isUndefined(options.symbols)) {\n    throw new Error('Either \"options.symbol\" or \"options.symbols\" must be defined.');\n  }\n\n  if (!_.isUndefined(options.symbol) && !_.isUndefined(options.symbols)) {\n    throw new Error('Either \"options.symbol\" or \"options.symbols\" must be undefined.');\n  }\n\n  if (!_.isUndefined(options.error) && !_.isBoolean(options.error)) {\n    throw new Error('\"options.error\" must be a boolean value');\n  }\n\n  if (!_.isUndefined(options.symbol)) {\n    if (!_.isString(options.symbol) || _.isEmpty(options.symbol)) {\n      throw new Error('\"options.symbol\" must be a non-empty string.');\n    }\n  } else {\n    if (!_.isArray(options.symbols) || _.isEmpty(options.symbols)) {\n      throw new Error('\"options.symbols\" must be a non-empty string array.');\n    }\n  }\n\n  if (_.isString(options.from) && !_.isEmpty(options.from)) {\n    options.from = moment(options.from);\n\n    if (!options.from.isValid()) {\n      throw new Error('\"options.from\" must be a valid date string.');\n    }\n  } else {\n    if (!_.isDate(options.from) && !_.isUndefined(options.from) && !_.isNull(options.from)) {\n      throw new Error('\"options.from\" must be a date or undefined/null.');\n    }\n\n    if (_.isDate(options.from)) {\n      options.from = moment(options.from);\n    }\n  }\n\n  if (_.isString(options.to) && !_.isEmpty(options.to)) {\n    options.to = moment(options.to);\n\n    if (!options.to.isValid()) {\n      throw new Error('\"options.to\" must be a valid date string.');\n    }\n  } else {\n    if (!_.isDate(options.to) && !_.isUndefined(options.to) && !_.isNull(options.to)) {\n      throw new Error('\"options.to\" must be a date or undefined/null.');\n    }\n\n    if (_.isDate(options.to)) {\n      options.to = moment(options.to);\n    }\n  }\n\n  if (_.isString(options.period)) {\n    if (!_.includes(['d', 'w', 'm', 'v'], options.period)) {\n      throw new Error('\"options.period\" must be \"d\", \"w\", \"m\", or \"v\".');\n    }\n  } else {\n    if (!_.isUndefined(options.period) && !_.isNull(options.period)) {\n      throw new Error('\"options.period\" must be a string or undefined/null.');\n    }\n  }\n\n  if (!options.from) {\n    options.from = moment('1900-01-01');\n  }\n\n  if (!options.to) {\n    options.to = moment({\n      hour: 0\n    });\n  }\n\n  if (!options.period) {\n    options.period = '1d';\n  }\n\n  options.events = 'history'; // Convert to yahoo v7 API\n\n  switch (options.period) {\n    case 'd':\n      options.period = '1d';\n      break;\n\n    case 'w':\n      options.period = '1wk';\n      break;\n\n    case 'm':\n      options.period = '1mo';\n      break;\n\n    case 'v':\n      options.period = '1d';\n      options.events = 'div';\n      break;\n    // No default case needed, options are sanitized above.\n  }\n\n  if ((options.from || options.to) && options.from.isAfter(options.to)) {\n    throw new Error('\"options.to\" must be be greater than or equal to \"options.from\".');\n  }\n}\n\nfunction _transformHistorical(symbol, data) {\n  var headings = data.shift();\n  return _(data).reverse().map(function (line) {\n    var result = {};\n    headings.forEach(function (heading, i) {\n      var value = line[i];\n\n      if (_.includes(['Volume'], heading)) {\n        value = _utils.toInt(value, null);\n      } else if (_.includes(['Open', 'High', 'Low', 'Close', 'Adj Close', 'Dividends'], heading)) {\n        value = _utils.toFloat(value, null);\n      } else if (_.includes(['Date'], heading)) {\n        value = _utils.toDate(value, null);\n\n        if (value && !moment(value).isValid()) {\n          value = null;\n        }\n      }\n\n      result[_utils.camelize(heading)] = value;\n    });\n    result.symbol = symbol;\n    return result;\n  }).value();\n}\n\nfunction historical(options, optionalHttpRequestOptions, cb) {\n  options = _.clone(options);\n\n  _sanitizeHistoricalOptions(options);\n\n  var symbols = options.symbols || _.flatten([options.symbol]);\n\n  if (optionalHttpRequestOptions && typeof optionalHttpRequestOptions === 'function') {\n    cb = optionalHttpRequestOptions;\n    optionalHttpRequestOptions = undefined;\n  }\n\n  return getCrumb(symbols[0]).then(function (crumb) {\n    return Promise.map(symbols, function (symbol) {\n      var url = _constants.HISTORICAL_DOWNLOAD_URL.replace(/\\$SYMBOL/, symbol);\n\n      return _utils.download(url, {\n        period1: options.from.format('X'),\n        period2: options.to.format('X'),\n        interval: options.period,\n        events: options.events,\n        crumb: crumb\n      }, optionalHttpRequestOptions).then(_utils.parseCSV).then(function (data) {\n        return _transformHistorical(symbol, data);\n      }).catch(function (err) {\n        if (options.error) {\n          throw err;\n        } else {\n          return [];\n        }\n      });\n    }, {\n      concurrency: options.maxConcurrentSymbols || os.cpus().length\n    }).then(function (result) {\n      if (options.symbols) {\n        return _.zipObject(symbols, result);\n      } else {\n        return result[0];\n      }\n    }).catch(function (err) {\n      throw new Error(util.format('Failed to download data (%s)', err.message));\n    }).nodeify(cb);\n  });\n}\n\nmodule.exports = historical;","map":{"version":3,"sources":["C:/Users/senya/Documents/Coding/React Projects/react-stock-ticker/node_modules/yahoo-finance/lib/historical.js"],"names":["os","require","util","_","S","moment","Promise","_constants","_utils","getCrumb","_sanitizeHistoricalOptions","options","isPlainObject","Error","isUndefined","symbol","symbols","error","isBoolean","isString","isEmpty","isArray","from","isValid","isDate","isNull","to","period","includes","hour","events","isAfter","_transformHistorical","data","headings","shift","reverse","map","line","result","forEach","heading","i","value","toInt","toFloat","toDate","camelize","historical","optionalHttpRequestOptions","cb","clone","flatten","undefined","then","crumb","url","HISTORICAL_DOWNLOAD_URL","replace","download","period1","format","period2","interval","parseCSV","catch","err","concurrency","maxConcurrentSymbols","cpus","length","zipObject","message","nodeify","module","exports"],"mappings":"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","sourcesContent":["var os = require('os');\nvar util = require('util');\n\nvar _ = require('lodash');\nvar S = require('string');\nvar moment = require('moment');\nvar Promise = require('bluebird');\n\nvar _constants = require('./constants');\nvar _utils = require('./utils');\nvar getCrumb = require('./yahooCrumb').getCrumb;\n\nfunction _sanitizeHistoricalOptions(options) {\n  if (!_.isPlainObject(options)) {\n    throw new Error('\"options\" must be a plain object.');\n  }\n  if (_.isUndefined(options.symbol) && _.isUndefined(options.symbols)) {\n    throw new Error('Either \"options.symbol\" or \"options.symbols\" must be defined.');\n  }\n  if (!_.isUndefined(options.symbol) && !_.isUndefined(options.symbols)) {\n    throw new Error('Either \"options.symbol\" or \"options.symbols\" must be undefined.');\n  }\n  if (!_.isUndefined(options.error) && !_.isBoolean(options.error)) {\n    throw new Error('\"options.error\" must be a boolean value');\n  }\n  if (!_.isUndefined(options.symbol)) {\n    if (!_.isString(options.symbol) || _.isEmpty(options.symbol)) {\n      throw new Error('\"options.symbol\" must be a non-empty string.');\n    }\n  } else {\n    if (!_.isArray(options.symbols) || _.isEmpty(options.symbols)) {\n      throw new Error('\"options.symbols\" must be a non-empty string array.');\n    }\n  }\n\n  if (_.isString(options.from) && !_.isEmpty(options.from)) {\n    options.from = moment(options.from);\n    if (!options.from.isValid()) {\n      throw new Error('\"options.from\" must be a valid date string.');\n    }\n  } else {\n    if (!_.isDate(options.from) && !_.isUndefined(options.from) && !_.isNull(options.from)) {\n      throw new Error('\"options.from\" must be a date or undefined/null.');\n    }\n    if (_.isDate(options.from)) {\n      options.from = moment(options.from);\n    }\n  }\n\n  if (_.isString(options.to) && !_.isEmpty(options.to)) {\n    options.to = moment(options.to);\n    if (!options.to.isValid()) {\n      throw new Error('\"options.to\" must be a valid date string.');\n    }\n  } else {\n    if (!_.isDate(options.to) && !_.isUndefined(options.to) && !_.isNull(options.to)) {\n      throw new Error('\"options.to\" must be a date or undefined/null.');\n    }\n    if (_.isDate(options.to)) {\n      options.to = moment(options.to);\n    }\n  }\n\n  if (_.isString(options.period)) {\n    if (!_.includes(['d', 'w', 'm', 'v'], options.period)) {\n      throw new Error('\"options.period\" must be \"d\", \"w\", \"m\", or \"v\".');\n    }\n  } else {\n    if (!_.isUndefined(options.period) && !_.isNull(options.period)) {\n      throw new Error('\"options.period\" must be a string or undefined/null.');\n    }\n  }\n\n  if (!options.from) {\n    options.from = moment('1900-01-01');\n  }\n\n  if (!options.to) {\n    options.to = moment({ hour: 0 });\n  }\n\n  if (!options.period) {\n    options.period = '1d';\n  }\n\n  options.events = 'history';\n\n  // Convert to yahoo v7 API\n  switch (options.period) {\n    case 'd': options.period = '1d'; break;\n    case 'w': options.period = '1wk'; break;\n    case 'm': options.period = '1mo'; break;\n    case 'v': options.period = '1d'; options.events = 'div'; break;\n    // No default case needed, options are sanitized above.\n  }\n\n  if ((options.from || options.to) && options.from.isAfter(options.to)) {\n    throw new Error('\"options.to\" must be be greater than or equal to \"options.from\".');\n  }\n}\n\nfunction _transformHistorical(symbol, data) {\n  var headings = data.shift();\n  return _(data)\n    .reverse()\n    .map(function (line) {\n      var result = {};\n      headings.forEach(function (heading, i) {\n        var value = line[i];\n        if (_.includes(['Volume'], heading)) {\n          value = _utils.toInt(value, null);\n        } else if (_.includes(['Open', 'High', 'Low', 'Close', 'Adj Close', 'Dividends'], heading)) {\n          value = _utils.toFloat(value, null);\n        } else if (_.includes(['Date'], heading)) {\n          value = _utils.toDate(value, null);\n          if (value && !moment(value).isValid()) {\n            value = null;\n          }\n        }\n        result[_utils.camelize(heading)] = value;\n      });\n      result.symbol = symbol;\n      return result;\n    })\n    .value();\n}\n\nfunction historical(options, optionalHttpRequestOptions, cb) {\n  options = _.clone(options);\n  _sanitizeHistoricalOptions(options);\n  var symbols = options.symbols || _.flatten([options.symbol]);\n\n  if(optionalHttpRequestOptions && typeof optionalHttpRequestOptions === 'function') {\n    cb = optionalHttpRequestOptions;\n    optionalHttpRequestOptions = undefined;\n  }\n\n  return getCrumb(symbols[0])\n    .then(function(crumb) {\n      return Promise.map(symbols, function (symbol) {\n        var url = _constants.HISTORICAL_DOWNLOAD_URL.replace(/\\$SYMBOL/, symbol);\n        return _utils.download(url, {\n          period1: options.from.format('X'),\n          period2: options.to.format('X'),\n          interval: options.period,\n          events: options.events,\n          crumb: crumb\n        }, optionalHttpRequestOptions)\n        .then(_utils.parseCSV)\n        .then(function (data) {\n          return _transformHistorical(symbol, data);\n        })\n        .catch(function (err) {\n          if (options.error) {\n            throw err;\n          } else {\n            return [];\n          }\n        });\n      }, {concurrency: options.maxConcurrentSymbols || os.cpus().length})\n      .then(function (result) {\n        if (options.symbols) {\n          return _.zipObject(symbols, result);\n        } else {\n          return result[0];\n        }\n      })\n      .catch(function (err) {\n        throw new Error(util.format('Failed to download data (%s)', err.message));\n      })\n      .nodeify(cb);\n    });\n}\n\nmodule.exports = historical;\n"]},"metadata":{},"sourceType":"script"}